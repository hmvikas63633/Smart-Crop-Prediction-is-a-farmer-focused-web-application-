<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Crop Prediction</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}body{font-family:Segoe UI,Tahoma,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:18px}.wrap{max-width:1180px;margin:auto}.head{text-align:center;color:#fff;margin-bottom:24px}.head h1{font-size:2.4rem}.head p{opacity:.95}.top{margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}.top a,.top select{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.65);background:rgba(255,255,255,.16);color:#fff;text-decoration:none;font-weight:700}.hero{max-width:760px;margin:14px auto 0;position:relative;border-radius:14px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.25)}.hero img{width:100%;height:190px;object-fit:cover;display:block}.ov{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.65));display:flex;align-items:flex-end;color:#fff;padding:12px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 28px rgba(0,0,0,.2)}h2{color:#6378e6;margin-bottom:14px}.wx{background:#eef3ff;border:1px solid #d1dcff;border-radius:10px;padding:10px;margin-bottom:12px}.wx-row{display:grid;grid-template-columns:1fr auto;gap:8px}.wx button{padding:8px 10px;border:1px solid #9fb5ff;background:#edf2ff;color:#3556db;border-radius:8px;font-weight:700;cursor:pointer}.wx p{font-size:.84rem;color:#43528f;margin-top:6px;min-height:16px}.fills{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}.fills button{padding:9px;border:2px solid #2196f3;background:#e3f2fd;color:#1976d2;border-radius:8px;cursor:pointer}.g{margin-bottom:12px}label{display:block;font-weight:700;margin-bottom:6px}input{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:10px}.hint{font-size:.82rem;color:#666;margin-top:4px}.btn{width:100%;padding:12px;border:none;border-radius:10px;color:#fff;background:linear-gradient(135deg,#667eea,#764ba2);font-weight:700;cursor:pointer}.btn:disabled{opacity:.65}.err{display:none;background:#ffebee;border-left:4px solid #c62828;color:#c62828;padding:10px;border-radius:8px;margin-bottom:10px}.load{display:none;text-align:center;padding:16px}.results{display:none}.item{padding:14px;border-radius:12px;background:#f2f5ff;margin-bottom:10px;border-left:4px solid #667eea}.item.p{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}.bar{height:8px;background:rgba(255,255,255,.35);border-radius:5px;overflow:hidden;margin:6px 0}.fill{height:100%;background:#4caf50}.act button{padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.2);color:inherit;cursor:pointer}.info{margin-top:20px}.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}.mini{background:#f5f7fa;border-radius:12px;padding:14px}.toast{position:fixed;right:14px;bottom:14px;background:rgba(23,28,56,.94);color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s}.toast.show{opacity:1;transform:translateY(0)}@media(max-width:860px){.grid{grid-template-columns:1fr}.wx-row{grid-template-columns:1fr}.fills{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<div class="head">
<h1 data-i18n="title">Smart Crop Prediction System</h1>
<p data-i18n="subtitle">AI-Powered Crop Recommendation for Farmers</p>
<div class="top">
<a href="/predict" data-i18n="predictNav">Prediction</a><a href="/grow-plan" data-i18n="growNav">Grow Plan</a><a href="/login" data-i18n="loginNav">Login</a><a href="#" id="logout" data-i18n="logoutNav">Logout</a>
<select id="lang" aria-label="Language"><option value="en">English</option><option value="hi">Hindi</option><option value="kn">Kannada</option><option value="ta">Tamil</option></select>
</div>
<div class="hero"><img src="https://images.unsplash.com/photo-1500937386664-56d1dfef3854?auto=format&fit=crop&w=1600&q=80" alt="Farm"><div class="ov" data-i18n="overlay">Predict smarter crops with soil + weather intelligence</div></div>
</div>
<div class="grid">
<div class="card">
<h2 data-i18n="inputTitle">Enter Soil and Climate Data</h2>
<div class="wx" aria-live="polite"><div class="wx-row"><input id="city" placeholder="Enter city" data-i18n-placeholder="cityPh"><button id="cityBtn" type="button" data-i18n="cityBtn">Weather by City</button></div><div style="margin-top:8px"><button id="geoBtn" type="button" data-i18n="geoBtn">Use My Location</button></div><p id="wxStatus" data-i18n="wxReady">Weather autofill is ready.</p></div>
<div class="wx" aria-live="polite">
<div style="font-weight:700;margin-bottom:6px">Soil Report Upload (Auto Fill NPK + pH)</div>
<div class="wx-row"><input id="reportFile" type="file" accept=".txt,.csv,.json,.md"><button id="reportParseBtn" type="button">Read Report File</button></div>
<div style="margin-top:8px"><textarea id="reportText" placeholder="Or paste soil report text here (example: Nitrogen 80, Phosphorus 40, Potassium 35, pH 6.8)" style="width:100%;min-height:78px;padding:10px;border:1px solid #cdd8ff;border-radius:8px"></textarea></div>
<div style="margin-top:8px"><button id="reportPasteBtn" type="button">Parse Pasted Text</button></div>
<p id="reportStatus" class="wx-status">Waiting for report input.</p>
</div>
<div class="fills"><button type="button" data-s="rice" data-i18n="rice">Rice Sample</button><button type="button" data-s="wheat" data-i18n="wheat">Wheat Sample</button><button type="button" data-s="cotton" data-i18n="cotton">Cotton Sample</button></div>
<form id="f">
<div class="g"><label for="n" data-i18n="n">Nitrogen (N)</label><input id="n" type="number" step="0.1" required><div class="hint" data-i18n="nH">Typical range: 0-140</div></div>
<div class="g"><label for="p" data-i18n="p">Phosphorus (P)</label><input id="p" type="number" step="0.1" required><div class="hint" data-i18n="pH">Typical range: 5-145</div></div>
<div class="g"><label for="k" data-i18n="k">Potassium (K)</label><input id="k" type="number" step="0.1" required><div class="hint" data-i18n="kH">Typical range: 5-205</div></div>
<div class="g"><label for="t" data-i18n="t">Temperature (C)</label><input id="t" type="number" step="0.1" required></div>
<div class="g"><label for="h" data-i18n="h">Humidity (%)</label><input id="h" type="number" step="0.1" min="0" max="100" required></div>
<div class="g"><label for="ph" data-i18n="ph">Soil pH</label><input id="ph" type="number" step="0.1" min="0" max="14" required></div>
<div class="g"><label for="r" data-i18n="r">Rainfall (mm)</label><input id="r" type="number" step="0.1" required></div>
<button id="predict" class="btn" type="submit" data-i18n="predictBtn">Predict Best Crop</button>
</form>
</div>
<div class="card"><h2 data-i18n="resultTitle">Prediction Results</h2><div id="err" class="err" role="alert"></div><div id="load" class="load" data-i18n="loading">Analyzing your data...</div><div id="res" class="results"></div><div id="empty" style="text-align:center;color:#888;padding:30px" data-i18n="empty">Enter soil and climate data to get recommendations</div></div>
</div>
<div class="card info"><h2 data-i18n="how">How to Use This Tool</h2><div class="cards"><div class="mini" data-i18n="s1">1. Collect soil data</div><div class="mini" data-i18n="s2">2. Fetch weather or enter values</div><div class="mini" data-i18n="s3">3. Get AI crop suggestion</div><div class="mini" data-i18n="s4">4. Save favorite crops</div></div></div>
<div class="card info"><h2>Crop Calendar (Season Wise)</h2><div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center"><input id="calendarState" placeholder="State (optional), e.g., Karnataka"><select id="calendarSeason"><option value="kharif">Kharif (Jun-Oct)</option><option value="rabi">Rabi (Nov-Apr)</option><option value="zaid">Zaid (Mar-Jun)</option></select></div><div id="calendarList" class="cards" style="margin-top:12px"></div></div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<script>
const AUTH_KEY="sc_auth_user",API_URL="http://localhost:5000/api",FAVORITES_KEY="favorite_crops",HISTORY_KEY="old_crops",LANG_KEY="sc_lang";
if(!localStorage.getItem(AUTH_KEY))location.href="/login";
const tr={en:{title:"Smart Crop Prediction System",subtitle:"AI-Powered Crop Recommendation for Farmers",predictNav:"Prediction",growNav:"Grow Plan",loginNav:"Login",logoutNav:"Logout",overlay:"Predict smarter crops with soil + weather intelligence",inputTitle:"Enter Soil and Climate Data",cityPh:"Enter city",cityBtn:"Weather by City",geoBtn:"Use My Location",wxReady:"Weather autofill is ready.",rice:"Rice Sample",wheat:"Wheat Sample",cotton:"Cotton Sample",n:"Nitrogen (N)",nH:"Typical range: 0-140",p:"Phosphorus (P)",pH:"Typical range: 5-145",k:"Potassium (K)",kH:"Typical range: 5-205",t:"Temperature (C)",h:"Humidity (%)",ph:"Soil pH",r:"Rainfall (mm)",predictBtn:"Predict Best Crop",resultTitle:"Prediction Results",loading:"Analyzing your data...",empty:"Enter soil and climate data to get recommendations",how:"How to Use This Tool",s1:"1. Collect soil data",s2:"2. Fetch weather or enter values",s3:"3. Get AI crop suggestion",s4:"4. Save favorite crops",best:"BEST MATCH",conf:"Confidence",fav:"Add to Favorite",toastFav:"Saved to favorites.",toastOut:"Logged out.",wxFail:"Could not fetch weather.",wxOk:"Weather updated",fillCity:"Please enter city.",locDeny:"Location denied.",predErr:"Unable to connect server.",preding:"Predicting..."},hi:{title:"स्मार्ट फसल भविष्यवाणी सिस्टम",subtitle:"किसानों के लिए AI आधारित फसल सुझाव",predictNav:"भविष्यवाणी",growNav:"ग्रो प्लान",loginNav:"लॉगिन",logoutNav:"लॉगआउट",overlay:"मिट्टी और मौसम से बेहतर फसल चुनें",inputTitle:"मिट्टी और मौसम का डेटा भरें",cityPh:"शहर लिखें",cityBtn:"शहर से मौसम",geoBtn:"मेरी लोकेशन",wxReady:"मौसम ऑटोफिल तैयार है।",rice:"चावल सैंपल",wheat:"गेहूं सैंपल",cotton:"कपास सैंपल",n:"नाइट्रोजन (N)",nH:"सामान्य रेंज: 0-140",p:"फॉस्फोरस (P)",pH:"सामान्य रेंज: 5-145",k:"पोटैशियम (K)",kH:"सामान्य रेंज: 5-205",t:"तापमान (C)",h:"आर्द्रता (%)",ph:"मिट्टी pH",r:"वर्षा (mm)",predictBtn:"सर्वश्रेष्ठ फसल बताएं",resultTitle:"परिणाम",loading:"डेटा विश्लेषण जारी...",empty:"सुझाव पाने के लिए डेटा भरें",how:"उपयोग कैसे करें",s1:"1. मिट्टी डेटा लें",s2:"2. मौसम लाएं या भरें",s3:"3. AI सुझाव लें",s4:"4. पसंदीदा फसल सेव करें",best:"सबसे अच्छा",conf:"विश्वास",fav:"पसंदीदा में जोड़ें",toastFav:"पसंदीदा में सेव।",toastOut:"लॉगआउट हुआ।",wxFail:"मौसम नहीं मिला।",wxOk:"मौसम अपडेट",fillCity:"शहर लिखें।",locDeny:"लोकेशन अनुमति नहीं।",predErr:"सर्वर से कनेक्ट नहीं।",preding:"भविष्यवाणी जारी..."}};
tr.kn={title:"ಸ್ಮಾರ್ಟ್ ಬೆಳೆ ಭವಿಷ್ಯವಾಣಿ ವ್ಯವಸ್ಥೆ",subtitle:"ರೈತರಿಗೆ AI ಆಧಾರಿತ ಬೆಳೆ ಶಿಫಾರಸು",predictNav:"ಭವಿಷ್ಯವಾಣಿ",growNav:"ಗ್ರೋ ಪ್ಲಾನ್",loginNav:"ಲಾಗಿನ್",logoutNav:"ಲಾಗ್ಔಟ್",overlay:"ಮಣ್ಣು ಮತ್ತು ಹವಾಮಾನದ ಆಧಾರದಲ್ಲಿ ಉತ್ತಮ ಬೆಳೆ ಆಯ್ಕೆಮಾಡಿ",inputTitle:"ಮಣ್ಣು ಮತ್ತು ಹವಾಮಾನ ಡೇಟಾ ನಮೂದಿಸಿ",cityPh:"ನಗರ ನಮೂದಿಸಿ",cityBtn:"ನಗರದಿಂದ ಹವಾಮಾನ",geoBtn:"ನನ್ನ ಸ್ಥಳ ಬಳಸಿ",wxReady:"ಹವಾಮಾನ ಆಟೋಫಿಲ್ ಸಿದ್ಧವಾಗಿದೆ.",rice:"ಅಕ್ಕಿ ಸ್ಯಾಂಪಲ್",wheat:"ಗೋಧಿ ಸ್ಯಾಂಪಲ್",cotton:"ಹತ್ತಿ ಸ್ಯಾಂಪಲ್",n:"ನೈಟ್ರೋಜನ್ (N)",nH:"ಸಾಮಾನ್ಯ ಮಿತಿ: 0-140",p:"ಫಾಸ್ಫರಸ್ (P)",pH:"ಸಾಮಾನ್ಯ ಮಿತಿ: 5-145",k:"ಪೊಟ್ಯಾಸಿಯಂ (K)",kH:"ಸಾಮಾನ್ಯ ಮಿತಿ: 5-205",t:"ತಾಪಮಾನ (C)",h:"ಆರ್ದ್ರತೆ (%)",ph:"ಮಣ್ಣು pH",r:"ಮಳೆ (mm)",predictBtn:"ಉತ್ತಮ ಬೆಳೆ ಊಹಿಸಿ",resultTitle:"ಫಲಿತಾಂಶಗಳು",loading:"ಡೇಟಾ ವಿಶ್ಲೇಷಣೆ ನಡೆಯುತ್ತಿದೆ...",empty:"ಶಿಫಾರಸು ಪಡೆಯಲು ಮಣ್ಣು ಮತ್ತು ಹವಾಮಾನ ಡೇಟಾ ನಮೂದಿಸಿ",how:"ಈ ಸಾಧನವನ್ನು ಹೇಗೆ ಬಳಸುವುದು",s1:"1. ಮಣ್ಣಿನ ಡೇಟಾ ಸಂಗ್ರಹಿಸಿ",s2:"2. ಹವಾಮಾನ ಪಡೆಯಿರಿ ಅಥವಾ ಕೈಯಲ್ಲಿ ನಮೂದಿಸಿ",s3:"3. AI ಬೆಳೆ ಶಿಫಾರಸು ಪಡೆಯಿರಿ",s4:"4. ಮೆಚ್ಚಿನ ಬೆಳೆಗಳನ್ನು ಉಳಿಸಿ",best:"ಅತ್ಯುತ್ತಮ",conf:"ವಿಶ್ವಾಸ",fav:"ಮೆಚ್ಚಿನಕ್ಕೆ ಸೇರಿಸಿ",toastFav:"ಮೆಚ್ಚಿನದಲ್ಲಿ ಉಳಿಸಲಾಗಿದೆ.",toastOut:"ಲಾಗ್ಔಟ್ ಆಯಿತು.",wxFail:"ಹವಾಮಾನ ಪಡೆಯಲಾಗಲಿಲ್ಲ.",wxOk:"ಹವಾಮಾನ ನವೀಕರಿಸಲಾಗಿದೆ",fillCity:"ದಯವಿಟ್ಟು ನಗರ ನಮೂದಿಸಿ.",locDeny:"ಸ್ಥಳ ಅನುಮತಿ ನಿರಾಕರಿಸಲಾಗಿದೆ.",predErr:"ಸರ್ವರ್ ಸಂಪರ್ಕ ವಿಫಲ.",preding:"ಭವಿಷ್ಯವಾಣಿ ನಡೆಯುತ್ತಿದೆ..."};
tr.ta={title:"ஸ்மார்ட் பயிர் கணிப்பு அமைப்பு",subtitle:"விவசாயிகளுக்கான AI அடிப்படையிலான பயிர் பரிந்துரை",predictNav:"கணிப்பு",growNav:"வளர்ப்பு திட்டம்",loginNav:"உள்நுழை",logoutNav:"வெளியேறு",overlay:"மண் மற்றும் வானிலையை வைத்து சிறந்த பயிரை தேர்வு செய்யுங்கள்",inputTitle:"மண் மற்றும் வானிலை தரவை உள்ளிடவும்",cityPh:"நகரம் உள்ளிடவும்",cityBtn:"நகரத்தின் வானிலை",geoBtn:"என் இடத்தை பயன்படுத்து",wxReady:"வானிலை தானியங்கு நிரப்பு தயாராக உள்ளது.",rice:"அரிசி மாதிரி",wheat:"கோதுமை மாதிரி",cotton:"பருத்தி மாதிரி",n:"நைட்ரஜன் (N)",nH:"வழக்கமான வரம்பு: 0-140",p:"பாஸ்பரஸ் (P)",pH:"வழக்கமான வரம்பு: 5-145",k:"பொட்டாசியம் (K)",kH:"வழக்கமான வரம்பு: 5-205",t:"வெப்பநிலை (C)",h:"ஈரப்பதம் (%)",ph:"மண் pH",r:"மழைப்பொழிவு (mm)",predictBtn:"சிறந்த பயிர் கணிக்க",resultTitle:"கணிப்பு முடிவுகள்",loading:"உங்கள் தரவு பகுப்பாய்வு செய்யப்படுகிறது...",empty:"பரிந்துரைகளை பெற மண் மற்றும் வானிலை தரவை உள்ளிடவும்",how:"இந்த கருவியை எப்படி பயன்படுத்துவது",s1:"1. மண் தரவை சேகரிக்கவும்",s2:"2. வானிலை பெறவும் அல்லது கைமுறையாக உள்ளிடவும்",s3:"3. AI பயிர் பரிந்துரையை பெறவும்",s4:"4. பிடித்த பயிர்களை சேமிக்கவும்",best:"சிறந்த தேர்வு",conf:"நம்பிக்கை",fav:"பிடித்ததில் சேர்",toastFav:"பிடித்ததில் சேமிக்கப்பட்டது.",toastOut:"வெற்றிகரமாக வெளியேறினீர்கள்.",wxFail:"வானிலை பெற முடியவில்லை.",wxOk:"வானிலை புதுப்பிக்கப்பட்டது",fillCity:"தயவு செய்து நகரத்தை உள்ளிடவும்.",locDeny:"இட அனுமதி மறுக்கப்பட்டது.",predErr:"சேவையக இணைப்பு தோல்வி.",preding:"கணிப்பு நடைபெறுகிறது..."};
const nEl=document.getElementById("n"),pEl=document.getElementById("p"),kEl=document.getElementById("k"),tEl=document.getElementById("t"),hEl=document.getElementById("h"),phEl=document.getElementById("ph"),rEl=document.getElementById("r"),cityEl=document.getElementById("city"),cityBtnEl=document.getElementById("cityBtn"),geoBtnEl=document.getElementById("geoBtn"),wxStatusEl=document.getElementById("wxStatus"),formEl=document.getElementById("f"),resEl=document.getElementById("res"),errEl=document.getElementById("err"),loadEl=document.getElementById("load"),emptyEl=document.getElementById("empty"),predictEl=document.getElementById("predict"),reportFileEl=document.getElementById("reportFile"),reportTextEl=document.getElementById("reportText"),reportStatusEl=document.getElementById("reportStatus"),reportParseBtnEl=document.getElementById("reportParseBtn"),reportPasteBtnEl=document.getElementById("reportPasteBtn"),calendarSeasonEl=document.getElementById("calendarSeason"),calendarStateEl=document.getElementById("calendarState"),calendarListEl=document.getElementById("calendarList");
let lang=localStorage.getItem(LANG_KEY)||"en";const trn=k=>(tr[lang]&&tr[lang][k])||tr.en[k]||k;
function i18n(){document.documentElement.lang=lang;document.querySelectorAll('[data-i18n]').forEach(e=>e.textContent=trn(e.dataset.i18n));document.querySelectorAll('[data-i18n-placeholder]').forEach(e=>e.placeholder=trn(e.dataset.i18nPlaceholder));wxStatusEl.textContent=trn('wxReady');document.getElementById('lang').value=lang}
i18n();
document.getElementById('lang').addEventListener('change',e=>{lang=e.target.value;localStorage.setItem(LANG_KEY,lang);i18n()});
let tt=null;function toast(m){const x=document.getElementById('toast');x.textContent=m;x.classList.add('show');clearTimeout(tt);tt=setTimeout(()=>x.classList.remove('show'),2200)}
document.getElementById('logout').addEventListener('click',e=>{e.preventDefault();localStorage.removeItem(AUTH_KEY);toast(trn('toastOut'));setTimeout(()=>location.href='/login',300)});
const samples={rice:{n:90,p:42,k:43,t:20.8,h:82,ph:6.5,r:202.9},wheat:{n:80,p:40,k:40,t:20,h:70,ph:6.5,r:150},cotton:{n:120,p:60,k:40,t:25,h:50,ph:7,r:100}};
document.querySelectorAll('.fills button').forEach(b=>b.addEventListener('click',()=>{const s=samples[b.dataset.s];nEl.value=s.n;pEl.value=s.p;kEl.value=s.k;tEl.value=s.t;hEl.value=s.h;phEl.value=s.ph;rEl.value=s.r;}));
const calendarData={kharif:["Rice","Maize","Cotton","Soybean","Groundnut","Sugarcane"],rabi:["Wheat","Barley","Gram","Mustard","Peas","Lentil"],zaid:["Watermelon","Cucumber","Muskmelon","Fodder Maize","Summer Moong","Pumpkin"]};
function renderCalendar(){const season=calendarSeasonEl.value;const state=calendarStateEl.value.trim();const crops=calendarData[season]||[];calendarListEl.innerHTML="";crops.forEach((c,i)=>{const d=document.createElement("div");d.className="mini";d.textContent=`${i+1}. ${c}${state?` (${state})`:""}`;calendarListEl.appendChild(d)})}
function readFileText(file){return new Promise((resolve,reject)=>{const fr=new FileReader();fr.onload=()=>resolve(String(fr.result||""));fr.onerror=()=>reject(new Error("read failed"));fr.readAsText(file)})}
function parseAndFillReportText(text){const src=String(text||"").toLowerCase();const pick=(patterns)=>{for(const p of patterns){const m=src.match(p);if(m&&m[1]!==undefined){const v=parseFloat(m[1]);if(!Number.isNaN(v))return v}}return null};const nVal=pick([/nitrogen[^0-9]{0,20}([0-9]+(?:\.[0-9]+)?)/,/[\s,]n[\s:=\-]+([0-9]+(?:\.[0-9]+)?)/]);const pVal=pick([/phosphorus[^0-9]{0,20}([0-9]+(?:\.[0-9]+)?)/,/[\s,]p[\s:=\-]+([0-9]+(?:\.[0-9]+)?)/]);const kVal=pick([/potassium[^0-9]{0,20}([0-9]+(?:\.[0-9]+)?)/,/[\s,]k[\s:=\-]+([0-9]+(?:\.[0-9]+)?)/]);const phVal=pick([/\bph[^0-9]{0,10}([0-9]+(?:\.[0-9]+)?)/]);if(nVal!==null)nEl.value=nVal;if(pVal!==null)pEl.value=pVal;if(kVal!==null)kEl.value=kVal;if(phVal!==null)phEl.value=phVal;const found=[nVal!==null?"N":"",pVal!==null?"P":"",kVal!==null?"K":"",phVal!==null?"pH":""].filter(Boolean);if(found.length){reportStatusEl.textContent=`Auto-filled: ${found.join(", ")}`;toast(`Auto-filled: ${found.join(", ")}`)}else{reportStatusEl.textContent="Could not find N, P, K, pH in report text."}}
reportPasteBtnEl.addEventListener("click",()=>parseAndFillReportText(reportTextEl.value));
reportParseBtnEl.addEventListener("click",async()=>{const f=reportFileEl.files&&reportFileEl.files[0];if(!f){reportStatusEl.textContent="Please choose a file first.";return}try{const txt=await readFileText(f);reportTextEl.value=txt.slice(0,12000);parseAndFillReportText(txt)}catch{reportStatusEl.textContent="File read failed. Use TXT/CSV/JSON text report."}});
calendarSeasonEl.addEventListener("change",renderCalendar);
calendarStateEl.addEventListener("input",renderCalendar);
renderCalendar();
function wxLoad(btn,on){btn.disabled=on;if(on){btn.dataset.old=btn.textContent;btn.textContent='...'}else{btn.textContent=btn.dataset.old||btn.textContent}}
async function wx(lat,lon){const u=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,precipitation&daily=precipitation_sum&timezone=auto`;const d=await (await fetch(u)).json();return{t:Number(d.current?.temperature_2m),h:Number(d.current?.relative_humidity_2m),rNow:Number(d.current?.precipitation),rDay:Number(d.daily?.precipitation_sum?.[0])}}
async function coords(city){const u=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`;const d=await (await fetch(u)).json();if(!d.results||!d.results.length)throw new Error('city');return d.results[0]}
function applyWx(w){if(!Number.isNaN(w.t))tEl.value=w.t.toFixed(1);if(!Number.isNaN(w.h))hEl.value=w.h.toFixed(1);const rainCurrent=!Number.isNaN(w.rNow)&&w.rNow>0;const rainDaily=!Number.isNaN(w.rDay)&&w.rDay>0;if(rainCurrent)rEl.value=w.rNow.toFixed(1);else if(rainDaily)rEl.value=w.rDay.toFixed(1);return{temp:!Number.isNaN(w.t)?w.t.toFixed(1):"-",hum:!Number.isNaN(w.h)?w.h.toFixed(1):"-",rain:(rainCurrent?w.rNow:rainDaily?w.rDay:NaN)}}
cityBtnEl.addEventListener('click',async()=>{const c=cityEl.value.trim();if(!c){toast(trn('fillCity'));return}wxLoad(cityBtnEl,true);try{const co=await coords(c),w=await wx(co.latitude,co.longitude),f=applyWx(w);const rainText=Number.isNaN(f.rain)?"rain unchanged":`${Number(f.rain).toFixed(1)} mm`;wxStatusEl.textContent=`${trn('wxOk')}: ${co.name} | T ${f.temp}C, H ${f.hum}%, R ${rainText}`;toast(`${trn('wxOk')}: ${co.name}`)}catch{wxStatusEl.textContent=trn('wxFail');toast(trn('wxFail'))}finally{wxLoad(cityBtnEl,false)}});
geoBtnEl.addEventListener('click',()=>{if(!navigator.geolocation){toast(trn('wxFail'));return}wxLoad(geoBtnEl,true);navigator.geolocation.getCurrentPosition(async p0=>{try{const w=await wx(p0.coords.latitude,p0.coords.longitude),f=applyWx(w);const rainText=Number.isNaN(f.rain)?"rain unchanged":`${Number(f.rain).toFixed(1)} mm`;wxStatusEl.textContent=`${trn('wxOk')} | T ${f.temp}C, H ${f.hum}%, R ${rainText}`;toast(trn('wxOk'))}catch{wxStatusEl.textContent=trn('wxFail');toast(trn('wxFail'))}finally{wxLoad(geoBtnEl,false)}},(err)=>{wxLoad(geoBtnEl,false);if(err&&err.code===1){wxStatusEl.textContent=`${trn('locDeny')} ${trn('fillCity')}`;toast(`${trn('locDeny')} ${trn('fillCity')}`);cityEl.focus()}else{wxStatusEl.textContent=trn('wxFail');toast(trn('wxFail'))}},{timeout:1e4})});
formEl.addEventListener('submit',async e=>{e.preventDefault();resEl.classList.remove('show');errEl.classList.remove('show');emptyEl.style.display='none';loadEl.style.display='block';predictEl.disabled=true;const old=predictEl.textContent;predictEl.textContent=trn('preding');const body={nitrogen:parseFloat(nEl.value),phosphorus:parseFloat(pEl.value),potassium:parseFloat(kEl.value),temperature:parseFloat(tEl.value),humidity:parseFloat(hEl.value),ph:parseFloat(phEl.value),rainfall:parseFloat(rEl.value)};try{const data=await (await fetch(`${API_URL}/predict`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})).json();if(data.success){render(data.recommendations)}else{showErr(data.error||'Prediction failed')}}catch{showErr(trn('predErr'))}finally{loadEl.style.display='none';predictEl.disabled=false;predictEl.textContent=old}});
function render(recs){resEl.innerHTML='';recs.forEach((rec,i)=>{const d=document.createElement('div');d.className=`item ${i===0?'p':''}`;d.innerHTML=`<div style="font-size:1.5rem;font-weight:800">${rec.emoji||''} ${String(rec.crop||'').toUpperCase()} ${i===0?`<span style="float:right">${trn('best')}</span>`:''}</div><div style="margin-top:6px">${trn('conf')}: ${rec.confidence}%</div><div class="bar"><div class="fill" style="width:${rec.confidence}%"></div></div><div>${rec.description||''}</div><div class="act" style="margin-top:8px"><button data-crop="${rec.crop}">${trn('fav')}</button></div>`;d.querySelector('button').addEventListener('click',()=>fav(rec.crop));resEl.appendChild(d);if(i===0)hist(rec.crop)});resEl.style.display='block';resEl.classList.add('show')}
function hist(c){const a=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');a.unshift({crop:c,savedAt:new Date().toISOString()});localStorage.setItem(HISTORY_KEY,JSON.stringify(a.slice(0,50)))}
function fav(c){const a=JSON.parse(localStorage.getItem(FAVORITES_KEY)||'[]');if(!a.map(x=>String(x).toLowerCase()).includes(String(c).toLowerCase())){a.push(c);localStorage.setItem(FAVORITES_KEY,JSON.stringify(a))}toast(trn('toastFav'))}
function showErr(m){errEl.textContent=m;errEl.style.display='block';errEl.classList.add('show')}
</script>
</body>
</html>
